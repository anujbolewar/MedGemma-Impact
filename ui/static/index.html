<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NeuroWeave Sentinel â€” Patient Dashboard</title>
  <style>
    /* â”€â”€ Reset + Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:          #0d0d0d;
      --surface:     #141414;
      --surface2:    #1c1c1c;
      --border:      #2a2a2a;
      --text:        #e8e8e8;
      --muted:       #888;
      --accent:      #4a90e2;
      --accent2:     #7ab4f5;
      --green:       #27ae60;
      --yellow:      #f39c12;
      --orange:      #e67e22;
      --red:         #e74c3c;
      --red-dark:    #c0392b;
      --purple:      #9b59b6;
      --teal:        #1abc9c;
      --radius:      8px;
      --font:        'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    html, body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      font-size: 16px;
      min-height: 100vh;
    }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    header h1 { font-size: 1.1rem; font-weight: 600; letter-spacing: .04em; }
    header h1 span { color: var(--accent); }

    #ws-badge {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: .78rem; color: var(--muted);
    }
    #ws-dot {
      width: 9px; height: 9px; border-radius: 50%;
      background: var(--red); transition: background .3s;
    }
    #ws-dot.connected { background: var(--green); }

    main {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: auto auto auto;
      gap: 16px;
      padding: 20px 24px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 18px;
    }
    .card-title {
      font-size: .72rem;
      font-weight: 600;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 12px;
    }

    /* â”€â”€ FSM State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #fsm-card { grid-column: 1; grid-row: 1; }
    #fsm-badge {
      display: inline-block;
      padding: 6px 18px;
      border-radius: 20px;
      font-size: 1.2rem;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      background: var(--surface2);
      color: var(--muted);
      transition: background .3s, color .3s;
    }
    #fsm-badge.IDLE           { background:#1a2a1a; color: var(--green); }
    #fsm-badge.TOKEN_SELECTION{ background:#1a1a2e; color: var(--accent2); }
    #fsm-badge.CONFIRMATION   { background:#2e2a14; color: var(--yellow); }
    #fsm-badge.GENERATING     { background:#1e1428; color: var(--purple); }
    #fsm-badge.VALIDATING     { background:#14242a; color: var(--teal); }
    #fsm-badge.SPEAKING       { background:#1a2e1e; color: var(--green); }
    #fsm-badge.EMERGENCY      { background:#2e1414; color: var(--red); }
    #fsm-badge.FALLBACK       { background:#2e1e14; color: var(--orange); }
    #fsm-reason { margin-top: 8px; font-size:.8rem; color: var(--muted); min-height:18px; }

    /* â”€â”€ Gaze â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #gaze-card { grid-column: 2; grid-row: 1; }
    #gaze-compass {
      width: 100px; height: 100px;
      border: 2px solid var(--border);
      border-radius: 50%;
      position: relative;
      margin: 0 auto 10px;
      background: radial-gradient(circle, #1c2030 0%, #0d0d0d 100%);
    }
    #gaze-dot {
      width: 14px; height: 14px; border-radius: 50%;
      background: var(--accent);
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      transition: top .15s, left .15s;
    }
    #gaze-label {
      text-align: center;
      font-size: 1rem; font-weight: 700;
      color: var(--accent);
      letter-spacing: .06em;
    }
    #gaze-conf { text-align: center; font-size: .78rem; color: var(--muted); margin-top: 4px; }

    /* â”€â”€ Confidence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #conf-card { grid-column: 3; grid-row: 1; }
    .meter-label { font-size: .8rem; color: var(--muted); margin-bottom: 6px; }
    .meter-bar {
      background: var(--surface2);
      border-radius: 6px;
      height: 12px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .meter-fill {
      height: 100%;
      border-radius: 6px;
      transition: width .4s ease;
      width: 0%;
    }
    #conf-fill   { background: var(--accent); }
    #safety-fill { background: var(--green); }
    .meter-value { font-size: .78rem; color: var(--muted); text-align: right; margin-top: -10px; margin-bottom: 12px; }

    /* â”€â”€ Sentence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #sentence-card { grid-column: 1 / 3; grid-row: 2; }
    #sentence-text {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--text);
      min-height: 48px;
      line-height: 1.3;
      word-break: break-word;
    }
    #sentence-text.speaking { color: var(--teal); }
    #sentence-latency { font-size: .75rem; color: var(--muted); margin-top: 6px; }

    /* â”€â”€ Safety â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #safety-card { grid-column: 3; grid-row: 2; }
    #safety-badge {
      display: inline-block;
      padding: 5px 14px;
      border-radius: 16px;
      font-size: .9rem; font-weight: 700;
      letter-spacing: .06em;
      background: var(--surface2);
      color: var(--muted);
      transition: background .3s, color .3s;
    }
    #safety-badge.PROCEED  { background: #1a2e1a; color: var(--green); }
    #safety-badge.CONFIRM  { background: #2e2a14; color: var(--yellow); }
    #safety-badge.FALLBACK { background: #2e1e14; color: var(--orange); }
    #safety-badge.BLOCK    { background: #2e1414; color: var(--red); }
    #safety-reasons {
      margin-top: 8px; font-size: .78rem; color: var(--muted);
      min-height: 18px;
    }

    /* â”€â”€ Tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #tokens-card { grid-column: 1; grid-row: 3; }
    #tokens-list {
      display: flex; flex-wrap: wrap; gap: 8px; min-height: 40px;
    }
    .token-chip {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 4px 12px;
      font-size: .82rem;
      color: var(--accent2);
      animation: pop .2s ease;
    }
    @keyframes pop {
      0%   { transform: scale(.8); opacity: 0; }
      100% { transform: scale(1);  opacity: 1; }
    }

    /* â”€â”€ Event Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #log-card { grid-column: 2 / 4; grid-row: 3; }
    #event-log {
      height: 130px;
      overflow-y: auto;
      font-size: .76rem;
      font-family: 'Cascadia Code', 'Consolas', monospace;
      color: var(--muted);
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }
    #event-log .log-entry {
      padding: 2px 0;
      border-bottom: 1px solid #1a1a1a;
    }
    #event-log .log-entry .ts { color: #444; }
    #event-log .t-emergency { color: var(--red); }
    #event-log .t-safety    { color: var(--yellow); }
    #event-log .t-speaking  { color: var(--teal); }
    #event-log .t-reconstruction { color: var(--accent2); }
    #event-log .t-fsm_state { color: var(--purple); }

    /* â”€â”€ Confirmation Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #confirm-panel {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.75);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    #confirm-panel.visible { display: flex; }
    #confirm-box {
      background: var(--surface);
      border: 2px solid var(--yellow);
      border-radius: 12px;
      padding: 30px 36px;
      max-width: 480px;
      width: 90%;
      text-align: center;
    }
    #confirm-box h2 { font-size: 1rem; color: var(--yellow); margin-bottom: 12px; }
    #confirm-sentence {
      font-size: 1.5rem; font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
      min-height: 36px;
    }
    #confirm-meta { font-size: .78rem; color: var(--muted); margin-bottom: 24px; }
    .confirm-btns { display: flex; gap: 16px; justify-content: center; }
    .btn-confirm {
      padding: 12px 32px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: opacity .2s;
    }
    .btn-confirm:hover { opacity: .85; }
    .btn-approve { background: var(--green);  color: #fff; }
    .btn-reject  { background: var(--red);    color: #fff; }

    /* â”€â”€ Emergency Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #emergency-section {
      grid-column: 1 / 4;
      padding: 0 0 8px 0;
    }
    #btn-emergency {
      width: 100%;
      padding: 16px;
      background: var(--red-dark);
      border: 2px solid var(--red);
      border-radius: var(--radius);
      color: #fff;
      font-size: 1.2rem;
      font-weight: 800;
      letter-spacing: .1em;
      cursor: pointer;
      text-transform: uppercase;
      transition: background .2s, transform .1s;
    }
    #btn-emergency:hover  { background: #a93226; }
    #btn-emergency:active { transform: scale(.98); }
    #btn-emergency.active { background: #7b241c; animation: pulse 1s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: .6; }
    }

    /* â”€â”€ Spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .spinner {
      display: inline-block; width: 14px; height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .7s linear infinite;
      vertical-align: middle; margin-left: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: none;
      }
      #sentence-card { grid-column: 1 / 3; }
      #log-card      { grid-column: 1 / 3; }
      #emergency-section { grid-column: 1 / 3; }
    }
    @media (max-width: 600px) {
      main { grid-template-columns: 1fr; padding: 12px; }
      #sentence-card, #log-card, #emergency-section { grid-column: 1; }
    }
  </style>
</head>
<body>

<header>
  <h1>Neuro<span>Weave</span> Sentinel &nbsp;Â·&nbsp; Patient Dashboard</h1>
  <span id="ws-badge">
    <span id="ws-dot"></span>
    <span id="ws-status">Connectingâ€¦</span>
  </span>
</header>

<main>

  <!-- â”€â”€ Emergency â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <section id="emergency-section">
    <button id="btn-emergency" onclick="sendEmergency()">
      ðŸš¨ &nbsp; EMERGENCY CALL
    </button>
  </section>

  <!-- â”€â”€ FSM State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="card" id="fsm-card">
    <div class="card-title">System State</div>
    <span id="fsm-badge" class="IDLE">IDLE</span>
    <div id="fsm-reason">â€”</div>
  </div>

  <!-- â”€â”€ Gaze Compass â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="card" id="gaze-card">
    <div class="card-title">Gaze Direction</div>
    <div id="gaze-compass">
      <div id="gaze-dot"></div>
    </div>
    <div id="gaze-label">CENTRE</div>
    <div id="gaze-conf">confidence: â€”</div>
  </div>

  <!-- â”€â”€ Confidence Meters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="card" id="conf-card">
    <div class="card-title">Confidence</div>
    <div class="meter-label">Gaze / Signal</div>
    <div class="meter-bar"><div class="meter-fill" id="conf-fill"></div></div>
    <div class="meter-value" id="conf-val">â€”</div>

    <div class="meter-label">Safety Score</div>
    <div class="meter-bar"><div class="meter-fill" id="safety-fill"></div></div>
    <div class="meter-value" id="safety-val">â€”</div>
  </div>

  <!-- â”€â”€ Reconstructed Sentence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="card" id="sentence-card">
    <div class="card-title">Reconstructed Sentence</div>
    <div id="sentence-text"><span style="color:var(--muted);font-size:.9rem;font-weight:400">Waiting for inputâ€¦</span></div>
    <div id="sentence-latency"></div>
  </div>

  <!-- â”€â”€ Safety Badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="card" id="safety-card">
    <div class="card-title">Safety Gate</div>
    <span id="safety-badge">â€”</span>
    <div id="safety-reasons"></div>
  </div>

  <!-- â”€â”€ Token Selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="card" id="tokens-card">
    <div class="card-title">Token Selection</div>
    <div id="tokens-list"><span style="color:var(--muted);font-size:.82rem">No tokens yet</span></div>
  </div>

  <!-- â”€â”€ Event Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="card" id="log-card">
    <div class="card-title">Event Log</div>
    <div id="event-log"></div>
  </div>

</main>

<!-- â”€â”€ Confirmation Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="confirm-panel">
  <div id="confirm-box">
    <h2>âš  Please Confirm Output</h2>
    <div id="confirm-sentence">â€¦</div>
    <div id="confirm-meta"></div>
    <div class="confirm-btns">
      <button class="btn-confirm btn-approve" onclick="sendConfirm(true)">âœ“ &nbsp;YES, SPEAK</button>
      <button class="btn-confirm btn-reject"  onclick="sendConfirm(false)">âœ— &nbsp;CANCEL</button>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WS_URL = `ws://${location.host}/ws`;
let ws = null;
let reconnectTimer = null;

function connect() {
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    setWsStatus(true);
    log('system', 'WebSocket connected', 'system');
  };

  ws.onclose = () => {
    setWsStatus(false);
    log('system', 'WebSocket disconnected â€” reconnecting in 3 s', 'system');
    reconnectTimer = setTimeout(connect, 3000);
  };

  ws.onerror = () => {
    setWsStatus(false);
  };

  ws.onmessage = e => {
    let msg;
    try { msg = JSON.parse(e.data); } catch { return; }
    handleMsg(msg);
  };
}

function setWsStatus(ok) {
  document.getElementById('ws-dot').className   = ok ? 'connected' : '';
  document.getElementById('ws-status').textContent = ok ? 'Live' : 'Disconnected';
}

// â”€â”€â”€ Message Dispatcher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleMsg(msg) {
  const handlers = {
    snapshot:       onSnapshot,
    fsm_state:      onFsmState,
    gaze:           onGaze,
    token:          onToken,
    reconstruction: onReconstruction,
    safety:         onSafety,
    speaking:       onSpeaking,
    fallback:       onFallback,
    emergency:      onEmergency,
    confirmation:   onConfirmation,
    tick:           onTick,
  };
  const h = handlers[msg.type];
  if (h) h(msg);
  if (msg.type !== 'tick') logMsg(msg);
}

// â”€â”€â”€ Handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onSnapshot(msg) {
  onFsmState({ state: msg.fsm_state, reason: '' });
  if (msg.gaze) onGaze(msg.gaze);
  if (msg.sentence) {
    el('sentence-text').textContent = msg.sentence;
    el('sentence-text').className = '';
  }
  if (msg.safety_action) {
    setSafetyBadge(msg.safety_action);
    setSafetyConf(msg.safety_confidence || 0);
  }
  if (msg.pending_confirmation) onConfirmation(msg.pending_confirmation);
  if (msg.emergency_active) setEmergencyActive(true);
}

function onFsmState(msg) {
  const badge = el('fsm-badge');
  badge.textContent = msg.state || 'â€”';
  badge.className   = msg.state || '';
  el('fsm-reason').textContent = msg.reason || 'â€”';

  // Hide confirm panel if state returns to IDLE
  if (msg.state === 'IDLE') hideConfirm();
  if (msg.state === 'EMERGENCY') setEmergencyActive(true);
  else setEmergencyActive(false);
}

function onGaze(msg) {
  const dir  = (msg.direction || 'CENTRE').toUpperCase();
  const conf = typeof msg.confidence === 'number' ? msg.confidence : 0;

  el('gaze-label').textContent = dir;
  el('gaze-conf').textContent  = `confidence: ${(conf * 100).toFixed(0)}%`;
  setGazeDot(dir);
  setConfMeter(conf);
}

// Map direction name â†’ compass dot position (%, centre = 50,50)
const DIR_POS = {
  UP:         [50, 18],
  DOWN:       [50, 82],
  LEFT:       [18, 50],
  RIGHT:      [82, 50],
  UP_LEFT:    [24, 24],
  UP_RIGHT:   [76, 24],
  DOWN_LEFT:  [24, 76],
  DOWN_RIGHT: [76, 76],
  CENTRE:     [50, 50],
  CENTER:     [50, 50],
};

function setGazeDot(dir) {
  const [x, y] = DIR_POS[dir] || [50, 50];
  const dot = el('gaze-dot');
  dot.style.left = x + '%';
  dot.style.top  = y + '%';
}

function onToken(msg) {
  const list = el('tokens-list');
  list.innerHTML = '';
  const codes = msg.codes || [];
  if (codes.length === 0) {
    list.innerHTML = '<span style="color:var(--muted);font-size:.82rem">No tokens yet</span>';
    return;
  }
  codes.forEach(c => {
    const chip = document.createElement('span');
    chip.className = 'token-chip';
    chip.textContent = c;
    list.appendChild(chip);
  });
}

function onReconstruction(msg) {
  const txt = el('sentence-text');
  txt.textContent = msg.text || '';
  txt.className   = '';
  el('sentence-latency').textContent =
    msg.latency_ms ? `Generated in ${Math.round(msg.latency_ms)} ms` : '';
}

function onSafety(msg) {
  setSafetyBadge(msg.action || '');
  setSafetyConf(msg.composite_confidence || msg.confidence || 0);
  const reasons = msg.reasons || [];
  el('safety-reasons').textContent = reasons.length ? reasons.join(' Â· ') : '';
}

function setSafetyBadge(action) {
  const badge = el('safety-badge');
  badge.textContent = action || 'â€”';
  badge.className   = action || '';
}

function setSafetyConf(v) {
  el('safety-fill').style.width  = (v * 100).toFixed(1) + '%';
  el('safety-fill').style.background =
    v >= 0.75 ? 'var(--green)' : v >= 0.45 ? 'var(--yellow)' : 'var(--red)';
  el('safety-val').textContent = (v * 100).toFixed(0) + '%';
}

function setConfMeter(v) {
  el('conf-fill').style.width = (v * 100).toFixed(1) + '%';
  el('conf-val').textContent  = (v * 100).toFixed(0) + '%';
}

function onSpeaking(msg) {
  const txt = el('sentence-text');
  txt.textContent = msg.text || txt.textContent;
  txt.className   = 'speaking';
  setTimeout(() => { txt.className = ''; }, 3000);
}

function onFallback(msg) {
  el('sentence-text').textContent = msg.text || '';
  el('sentence-text').className   = '';
}

function onEmergency(msg) {
  setEmergencyActive(true);
}

function setEmergencyActive(active) {
  el('btn-emergency').className = active ? 'active' : '';
}

function onConfirmation(msg) {
  el('confirm-sentence').textContent = msg.text || '';
  const conf = msg.confidence || msg.composite_confidence || 0;
  el('confirm-meta').textContent =
    `Confidence: ${(conf * 100).toFixed(0)}%  Â·  Auto-timeout in 30 s`;
  showConfirm();
}

function onTick(msg) {
  // Optional: update a clock or heartbeat indicator
}

// â”€â”€â”€ Confirmation Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showConfirm() {
  el('confirm-panel').classList.add('visible');
}
function hideConfirm() {
  el('confirm-panel').classList.remove('visible');
}
function sendConfirm(approved) {
  hideConfirm();
  wsSend({ action: approved ? 'confirm' : 'cancel' });
}

// â”€â”€â”€ Emergency â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendEmergency() {
  wsSend({ action: 'emergency' });
  fetch('/emergency', { method: 'POST' }).catch(() => {});
  setEmergencyActive(true);
  log('emergency', 'ðŸš¨ Emergency triggered by operator', 'emergency');
}

// â”€â”€â”€ WS Send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function wsSend(obj) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(obj));
  }
}

// â”€â”€â”€ Event Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MAX_LOG = 120;

function logMsg(msg) {
  const typeMap = {
    fsm_state:      `FSM â†’ ${msg.state || ''}`,
    gaze:           `Gaze: ${msg.direction || ''} (${((msg.confidence||0)*100).toFixed(0)}%)`,
    token:          `Tokens: [${(msg.codes||[]).join(', ')}]`,
    reconstruction: `Sentence: "${msg.text || ''}" (${Math.round(msg.latency_ms||0)} ms)`,
    safety:         `Safety: ${msg.action || ''} @ ${((msg.composite_confidence||0)*100).toFixed(0)}%`,
    speaking:       `Speaking: "${msg.text || ''}"`,
    fallback:       `Fallback: "${msg.text || ''}"`,
    emergency:      `ðŸš¨ EMERGENCY (${msg.source || 'manual'})`,
    confirmation:   `Confirm requested: "${msg.text || ''}"`,
    snapshot:       'Snapshot received',
  };
  const text = typeMap[msg.type] || JSON.stringify(msg).slice(0, 80);
  log(msg.type, text, msg.type);
}

function log(type, text, cssClass) {
  const now = new Date();
  const ts  = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
  const logDiv = el('event-log');
  const entry  = document.createElement('div');
  entry.className = `log-entry t-${cssClass || ''}`;
  entry.innerHTML = `<span class="ts">${ts}</span>  ${esc(text)}`;
  logDiv.appendChild(entry);
  // Trim old entries
  while (logDiv.children.length > MAX_LOG) {
    logDiv.removeChild(logDiv.firstChild);
  }
  logDiv.scrollTop = logDiv.scrollHeight;
}

// â”€â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const el  = id => document.getElementById(id);
const pad = n  => String(n).padStart(2, '0');
function esc(s) {
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;');
}

// â”€â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
connect();
</script>
</body>
</html>
